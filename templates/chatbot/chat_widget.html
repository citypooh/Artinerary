<!-- templates/chatbot/chat_widget.html -->
<style>
    .chat-toggle-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: white;
        color: black;
        border: 3px solid white;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s, box-shadow 0.3s;
        z-index: 10000;
    }
    .chat-toggle-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(255, 255, 255, 0.5);
        background: #f5f5f5;
    }
    .chat-toggle-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ff0000;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    .chat-window {
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 380px;
        height: 580px;
        min-width: 320px;
        min-height: 400px;
        max-width: 600px;
        max-height: 800px;
        background: white;
        border: 1px solid white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(255, 255, 255, 0.2);
        display: none;
        flex-direction: column;
        z-index: 10001;
        animation: slideUp 0.3s ease-out;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    .chat-window.open { display: flex; }
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .chat-resize-handle {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 20px;
        height: 20px;
        cursor: nwse-resize;
        z-index: 10;
    }
    .chat-resize-handle::after {
        content: '';
        position: absolute;
        bottom: 3px;
        right: 3px;
        width: 12px;
        height: 12px;
        background: linear-gradient(135deg, transparent 50%, #666 50%);
    }
    .chat-header {
        background: black;
        color: white;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #ddd;
        border-radius: 11px 11px 0 0;
        flex-shrink: 0;
        cursor: move;
    }
    .chat-header-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .chat-avatar {
        width: 40px;
        height: 40px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .chat-bot-info { display: flex; flex-direction: column; }
    .chat-bot-name {
        font-weight: 600;
        font-size: 16px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }
    .chat-bot-status {
        font-size: 12px;
        opacity: 0.8;
        display: flex;
        align-items: center;
        gap: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .status-dot {
        width: 6px;
        height: 6px;
        background: #00ff00;
        border-radius: 50%;
        display: inline-block;
    }
    .chat-header-buttons {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .chat-clear-btn {
        background: none;
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        font-size: 11px;
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 4px;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .chat-clear-btn:hover { 
        background: rgba(255,255,255,0.1); 
        border-color: rgba(255,255,255,0.5);
    }
    .chat-close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.3s;
    }
    .chat-close-btn:hover { opacity: 0.7; }
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: white;
    }
    .chat-messages::-webkit-scrollbar { width: 6px; }
    .chat-messages::-webkit-scrollbar-track { background: #f1f1f1; }
    .chat-messages::-webkit-scrollbar-thumb { background: #000; border-radius: 3px; }
    .message { animation: fadeIn 0.3s ease-out; max-width: 85%; }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .message.user { align-self: flex-end; }
    .message.bot { align-self: flex-start; display: flex; gap: 8px; }
    .message-avatar {
        width: 28px;
        height: 28px;
        background: white;
        border: 1px solid #000;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-top: 4px;
    }
    .message-content {
        background: white;
        padding: 12px 16px;
        border: 1px solid #000;
        border-radius: 8px;
        color: #000;
    }
    .message.user .message-content {
        background: #000;
        color: white;
        border: 1px solid #000;
    }
    .message.bot .message-content {
        background: #f9f9f9;
        border: 1px solid #ddd;
    }
    .message-timestamp {
        font-size: 11px;
        opacity: 0.6;
        margin-top: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .message.user .message-timestamp { text-align: right; color: #ccc; }
    .content-warning-banner {
        background: #fff3cd;
        border: 1px solid #ffc107;
        color: #856404;
        padding: 10px 14px;
        border-radius: 6px;
        margin-bottom: 10px;
        font-size: 13px;
    }
    .content-warning-banner.severe {
        background: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
    }
    .quick-actions {
        padding: 12px 20px;
        border-top: 1px solid #ddd;
        background: white;
        display: flex;
        gap: 8px;
        flex-shrink: 0;
    }
    .quick-action-btn {
        flex: 1;
        padding: 10px;
        background: white;
        border: 1px solid #000;
        color: black;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        border-radius: 4px;
    }
    .quick-action-btn:hover { background: black; color: white; }
    .chat-input-container {
        padding: 16px 20px;
        border-top: 1px solid #ddd;
        background: white;
        display: flex;
        gap: 12px;
        align-items: flex-end;
        border-radius: 0 0 11px 11px;
        flex-shrink: 0;
    }
    .location-btn {
        width: 40px;
        height: 40px;
        background: white;
        border: 1px solid #000;
        color: black;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        flex-shrink: 0;
        border-radius: 4px;
    }
    .location-btn:hover { background: black; color: white; }
    .input-wrapper { flex: 1; position: relative; }
    .char-counter {
        position: absolute;
        bottom: 8px;
        right: 12px;
        font-size: 10px;
        color: #666;
        background: rgba(255, 255, 255, 0.9);
        padding: 2px 6px;
        border-radius: 3px;
        pointer-events: none;
    }
    .char-counter.warning { color: #ff6600; }
    .char-counter.error { color: #ff0000; font-weight: bold; }
    .chat-input {
        width: 100%;
        padding: 12px 60px 12px 12px;
        border: 1px solid #000;
        background: white;
        color: black;
        font-size: 14px;
        font-family: inherit;
        resize: none;
        min-height: 40px;
        max-height: 150px;
        overflow-y: auto;
        line-height: 1.4;
        border-radius: 4px;
    }
    .chat-input:focus { outline: none; box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1); }
    .chat-input::placeholder { color: #999; }
    .send-btn {
        width: 40px;
        height: 40px;
        background: black;
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        flex-shrink: 0;
        border-radius: 4px;
    }
    .send-btn:hover { background: #333; }
    .send-btn:disabled { background: #ccc; cursor: not-allowed; }
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 12px 16px;
        background: #f9f9f9;
        border: 1px solid #ddd;
        width: fit-content;
        border-radius: 8px;
    }
    .typing-dot {
        width: 8px;
        height: 8px;
        background: black;
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
        30% { transform: translateY(-10px); opacity: 1; }
    }
    .action-button {
        margin-top: 12px;
        padding: 10px 16px;
        background: black;
        color: white;
        border: none;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-block;
        text-decoration: none;
        text-align: center;
        border-radius: 4px;
    }
    .action-button:hover { background: #333; color: white; }
    .navigation-button {
        margin-top: 12px;
        padding: 10px 16px;
        background: black;
        color: white;
        border: none;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-block;
        text-decoration: none;
        text-align: center;
        border-radius: 4px;
    }
    .navigation-button:hover { background: #333; color: white; }
    .artworks-list { margin-top: 12px; display: flex; flex-direction: column; gap: 10px; }
    .artwork-card {
        background: white;
        padding: 12px;
        border: 1px solid #eee;
        border-radius: 6px;
        border-left: 3px solid #000;
    }
    .artwork-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
    }
    .artwork-artist, .artwork-location, .artwork-distance {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
    }
    .itinerary-prompt-buttons {
        margin-top: 12px;
        display: flex;
        gap: 10px;
    }
    .itinerary-prompt-buttons .yes-button {
        background: #28a745;
    }
    .itinerary-prompt-buttons .yes-button:hover {
        background: #218838;
    }
    .itinerary-prompt-buttons .no-button {
        background: #6c757d;
    }
    .itinerary-prompt-buttons .no-button:hover {
        background: #5a6268;
    }
    @media (max-width: 768px) {
        .chat-window {
            bottom: 0;
            right: 0;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            border-radius: 0;
        }
        .chat-header { border-radius: 0; }
        .chat-input-container { border-radius: 0; }
        .chat-toggle-btn { bottom: 15px; right: 15px; }
    }
</style>

<button class="chat-toggle-btn" id="chatToggle">
    <svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor">
        <rect x="11" y="1" width="2" height="4"/>
        <circle cx="12" cy="2" r="1.5"/>
        <rect x="4" y="6" width="16" height="14" rx="2" ry="2"/>
        <circle cx="9" cy="11" r="1.5" fill="white"/>
        <circle cx="15" cy="11" r="1.5" fill="white"/>
        <rect x="8" y="15" width="8" height="1.5" rx="0.75" fill="white"/>
    </svg>
    <span class="chat-toggle-badge" id="unreadBadge" style="display: none;">0</span>
</button>

<div class="chat-window" id="chatWindow">
    <div class="chat-header" id="chatHeader">
        <div class="chat-header-info">
            <div class="chat-avatar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="black">
                    <rect x="11" y="1" width="2" height="4"/>
                    <circle cx="12" cy="2" r="1.5"/>
                    <rect x="4" y="6" width="16" height="14" rx="2" ry="2"/>
                    <circle cx="9" cy="11" r="1.5" fill="white"/>
                    <circle cx="15" cy="11" r="1.5" fill="white"/>
                    <rect x="8" y="15" width="8" height="1.5" rx="0.75" fill="white"/>
                </svg>
            </div>
            <div class="chat-bot-info">
                <span class="chat-bot-name">ARTBOT</span>
                <span class="chat-bot-status"><span class="status-dot"></span> ONLINE</span>
            </div>
        </div>
        <div class="chat-header-buttons">
            <button class="chat-clear-btn" id="chatClear" title="Clear chat history">Clear</button>
            <button class="chat-close-btn" id="chatClose">Ã—</button>
        </div>
    </div>

    <div class="chat-messages" id="chatMessages"></div>

    <div class="quick-actions">
        <button class="quick-action-btn" data-action="nearby">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            NEARBY
        </button>
        <button class="quick-action-btn" data-action="plan">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
            PLAN
        </button>
        <button class="quick-action-btn" data-action="help">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg>
            HELP
        </button>
    </div>

    <div class="chat-input-container">
        <button class="location-btn" id="locationBtn" title="Share location">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
        </button>
        <div class="input-wrapper">
            <textarea class="chat-input" id="chatInput" placeholder="Type your message..." rows="1" maxlength="500"></textarea>
            <div class="char-counter" id="charCounter">0/500</div>
        </div>
        <button class="send-btn" id="sendBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
    </div>
    <div class="chat-resize-handle" id="resizeHandle"></div>
</div>

<script>
(function() {
    const chatWindow = document.getElementById('chatWindow');
    const chatToggle = document.getElementById('chatToggle');
    const chatClose = document.getElementById('chatClose');
    const chatClear = document.getElementById('chatClear');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const locationBtn = document.getElementById('locationBtn');
    const unreadBadge = document.getElementById('unreadBadge');
    const quickActionBtns = document.querySelectorAll('.quick-action-btn');
    const charCounter = document.getElementById('charCounter');
    const chatHeader = document.getElementById('chatHeader');
    const resizeHandle = document.getElementById('resizeHandle');

    const chatState = {
        isOpen: false,
        sessionId: null,
        unreadCount: 0,
        userLocation: null
    };

    init();

    function init() {
        chatState.sessionId = sessionStorage.getItem('chatSessionId') || generateSessionId();
        sessionStorage.setItem('chatSessionId', chatState.sessionId);
        loadChatHistory();
        setTimeout(() => { if (chatMessages.children.length === 0) addWelcomeMessage(); }, 500);
        setupAutoExpandingTextarea();
        setupDragFunctionality();
        setupResizeFunctionality();
    }

    function generateSessionId() {
        return 'chat_' + Date.now() + '_' + Math.random().toString(36).substring(7);
    }

    function setupDragFunctionality() {
        let isDragging = false, startX, startY, currentX, currentY;
        chatHeader.addEventListener('mousedown', function(e) {
            if (window.innerWidth <= 768) return;
            if (e.target.closest('.chat-clear-btn') || e.target.closest('.chat-close-btn')) return;
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            const rect = chatWindow.getBoundingClientRect();
            currentX = rect.left;
            currentY = rect.top;
        });
        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            e.preventDefault();
            chatWindow.style.left = (currentX + e.clientX - startX) + 'px';
            chatWindow.style.top = (currentY + e.clientY - startY) + 'px';
            chatWindow.style.right = 'auto';
            chatWindow.style.bottom = 'auto';
        });
        document.addEventListener('mouseup', function() { isDragging = false; });
    }

    function setupResizeFunctionality() {
        let isResizing = false, startX, startY, startWidth, startHeight;
        resizeHandle.addEventListener('mousedown', function(e) {
            if (window.innerWidth <= 768) return;
            isResizing = true;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = parseInt(getComputedStyle(chatWindow).width, 10);
            startHeight = parseInt(getComputedStyle(chatWindow).height, 10);
            e.preventDefault();
        });
        document.addEventListener('mousemove', function(e) {
            if (!isResizing) return;
            const w = Math.max(320, Math.min(600, startWidth + (e.clientX - startX)));
            const h = Math.max(400, Math.min(800, startHeight + (e.clientY - startY)));
            chatWindow.style.width = w + 'px';
            chatWindow.style.height = h + 'px';
        });
        document.addEventListener('mouseup', function() { isResizing = false; });
    }

    function setupAutoExpandingTextarea() {
        chatInput.addEventListener('input', function() {
            this.style.height = '40px';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            const count = this.value.length;
            charCounter.textContent = count + '/500';
            charCounter.className = 'char-counter' + (count > 450 ? ' error' : (count > 375 ? ' warning' : ''));
        });
    }

    function toggleChat() {
        chatState.isOpen = !chatState.isOpen;
        chatWindow.classList.toggle('open', chatState.isOpen);
        if (chatState.isOpen) {
            chatState.unreadCount = 0;
            updateUnreadBadge();
            chatInput.focus();
        }
    }

    function updateUnreadBadge() {
        unreadBadge.textContent = chatState.unreadCount;
        unreadBadge.style.display = chatState.unreadCount > 0 ? 'flex' : 'none';
    }

    function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        addMessage(message, 'user');
        chatInput.value = '';
        chatInput.style.height = '40px';
        charCounter.textContent = '0/500';
        charCounter.className = 'char-counter';
        showTypingIndicator();

        fetch('/chatbot/api/chat/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ message: message, session_id: chatState.sessionId, location: chatState.userLocation })
        })
        .then(r => r.json())
        .then(data => {
            hideTypingIndicator();
            addMessage(data.response, 'bot', data.metadata);
        })
        .catch(err => {
            hideTypingIndicator();
            addMessage('Sorry, an error occurred. Please try again.', 'bot');
        });
    }

    function clearChat() {
        if (!confirm('Are you sure you want to clear the chat history?')) return;
        
        fetch('/chatbot/api/clear/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ session_id: chatState.sessionId })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                chatMessages.innerHTML = '';
                addWelcomeMessage();
                addMessage('Chat history cleared. How can I help you?', 'bot');
            }
        })
        .catch(err => {
            console.error('Error clearing chat:', err);
        });
    }

    function getLocation() {
        if (!navigator.geolocation) {
            addMessage('Geolocation not supported by your browser.', 'bot');
            return;
        }
        locationBtn.style.opacity = '0.5';
        navigator.geolocation.getCurrentPosition(
            pos => {
                chatState.userLocation = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
                locationBtn.style.opacity = '1';
                addMessage('ðŸ“ Location shared successfully!', 'user');
            },
            err => {
                locationBtn.style.opacity = '1';
                addMessage('Unable to get location. Please enable location services.', 'bot');
            }
        );
    }

    function handleQuickAction(action) {
        const actions = { 
            nearby: "Show me artworks nearby", 
            plan: "Help me plan an art tour", 
            help: "What can you help me with?" 
        };
        if (actions[action]) { 
            chatInput.value = actions[action]; 
            sendMessage(); 
        }
    }

    function addMessage(text, sender, metadata = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ' + sender;

        if (sender === 'bot') {
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="black"><rect x="11" y="1" width="2" height="4"/><circle cx="12" cy="2" r="1.5"/><rect x="4" y="6" width="16" height="14" rx="2" ry="2"/><circle cx="9" cy="11" r="1.5" fill="white"/><circle cx="15" cy="11" r="1.5" fill="white"/><rect x="8" y="15" width="8" height="1.5" rx="0.75" fill="white"/></svg>';
            messageDiv.appendChild(avatarDiv);
        }

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        // Process text - convert newlines to <br>
        let messageContent = text.replace(/\n/g, '<br>');

        if (metadata) {
            // Content warning
            if (metadata.content_warning) {
                const severity = metadata.moderation_severity === 'report' ? 'severe' : '';
                messageContent = '<div class="content-warning-banner ' + severity + '">' + messageContent + '</div>';
            }

            // Artworks list
            if (metadata.artworks && metadata.artworks.length > 0) {
                messageContent += '<div class="artworks-list">';
                metadata.artworks.forEach(art => {
                    messageContent += '<div class="artwork-card">' +
                        '<div class="artwork-title">' + escapeHtml(art.title) + '</div>' +
                        '<div class="artwork-artist">' + escapeHtml(art.artist) + '</div>' +
                        '<div class="artwork-location">' + escapeHtml(art.location) + '</div>' +
                        (art.distance ? '<div class="artwork-distance">' + art.distance + ' miles away</div>' : '') +
                        '</div>';
                });
                messageContent += '</div>';
            }

            // Itinerary prompt buttons
            if (metadata.show_itinerary_prompt && metadata.suggested_locations) {
                messageContent += '<div class="itinerary-prompt-buttons">' +
                    '<button class="action-button yes-button" onclick="handleItineraryResponse(true)">âœ“ Yes, Create Itinerary</button>' +
                    '<button class="action-button no-button" onclick="handleItineraryResponse(false)">âœ— No, Thanks</button>' +
                    '</div>';
                window.suggestedLocationIds = metadata.suggested_locations;
            }

            // Navigation button
            if (metadata.navigation) {
                const navName = metadata.navigation.name || 'Go';
                messageContent += '<a href="' + metadata.navigation.url + '" class="navigation-button">' + escapeHtml(navName) + '</a>';
            }

            // Action button
            if (metadata.action_button) {
                messageContent += '<a href="' + metadata.action_button.url + '" class="action-button">' + escapeHtml(metadata.action_button.text) + '</a>';
            }
        }

        contentDiv.innerHTML = messageContent;
        
        const timestamp = document.createElement('div');
        timestamp.className = 'message-timestamp';
        timestamp.textContent = 'just now';
        contentDiv.appendChild(timestamp);
        
        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        if (sender === 'bot' && !chatState.isOpen) {
            chatState.unreadCount++;
            updateUnreadBadge();
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function addWelcomeMessage() {
        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'message bot';
        welcomeDiv.innerHTML = '<div class="message-avatar"><svg width="20" height="20" viewBox="0 0 24 24" fill="black"><rect x="11" y="1" width="2" height="4"/><circle cx="12" cy="2" r="1.5"/><rect x="4" y="6" width="16" height="14" rx="2" ry="2"/><circle cx="9" cy="11" r="1.5" fill="white"/><circle cx="15" cy="11" r="1.5" fill="white"/><rect x="8" y="15" width="8" height="1.5" rx="0.75" fill="white"/></svg></div>' +
            '<div class="message-content">' +
            '<div>Hello! I\'m ArtBot, your NYC public art assistant.</div><br>' +
            '<div>I can help you:</div>' +
            '<div style="margin-top: 8px; margin-left: 10px;">' +
            'â€¢ Find artworks near you or in specific areas<br>' +
            'â€¢ Plan art tours and itineraries<br>' +
            'â€¢ Navigate the website<br>' +
            'â€¢ Answer questions about NYC public art</div><br>' +
            '<div>How can I assist you today?</div>' +
            '<div class="message-timestamp">just now</div>' +
            '</div>';
        chatMessages.appendChild(welcomeDiv);
    }

    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = '<div class="message-avatar"><svg width="20" height="20" viewBox="0 0 24 24" fill="black"><rect x="11" y="1" width="2" height="4"/><circle cx="12" cy="2" r="1.5"/><rect x="4" y="6" width="16" height="14" rx="2" ry="2"/><circle cx="9" cy="11" r="1.5" fill="white"/><circle cx="15" cy="11" r="1.5" fill="white"/><rect x="8" y="15" width="8" height="1.5" rx="0.75" fill="white"/></svg></div><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTypingIndicator() {
        const el = document.getElementById('typing-indicator');
        if (el) el.remove();
    }

    function loadChatHistory() {
        fetch('/chatbot/api/history/?session_id=' + chatState.sessionId)
            .then(r => r.json())
            .then(data => {
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => addMessage(msg.message, msg.sender, msg.metadata));
                }
            })
            .catch(err => console.error('Error loading history:', err));
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie) {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Global function for itinerary response
    window.handleItineraryResponse = function(create) {
        if (create && window.suggestedLocationIds && window.suggestedLocationIds.length > 0) {
            addMessage('Great! Redirecting you to create your itinerary...', 'bot');
            setTimeout(() => { window.location.href = '/itineraries/create/'; }, 1000);
        } else {
            addMessage('No problem! Feel free to ask me anything else about NYC public art.', 'bot');
            window.suggestedLocationIds = null;
        }
        document.querySelectorAll('.itinerary-prompt-buttons button').forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
        });
    };

    // Event listeners
    chatToggle.addEventListener('click', toggleChat);
    chatClose.addEventListener('click', () => { chatState.isOpen = false; chatWindow.classList.remove('open'); });
    chatClear.addEventListener('click', clearChat);
    sendBtn.addEventListener('click', sendMessage);
    locationBtn.addEventListener('click', getLocation);
    chatInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    quickActionBtns.forEach(btn => btn.addEventListener('click', () => handleQuickAction(btn.dataset.action)));
})();
</script>