<style>
/* Direct Chat Widget - Fixed to bottom right */
.direct-chat-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
}

/* Conversation List Button */
.conversations-button {
    background: rgba(102, 126, 234, 0.2);
    border: 1px solid rgba(102, 126, 234, 0.4);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #8b9cff;
    font-size: 0.9rem;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.conversations-button:hover {
    background: rgba(102, 126, 234, 0.3);
    transform: translateY(-2px);
}

.unread-badge {
    background: #fa709a;
    color: white;
    font-size: 0.7rem;
    padding: 0.15rem 0.4rem;
    border-radius: 10px;
    font-weight: 500;
}

/* Chat tabs (minimized) */
.chat-tab {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid rgba(102, 126, 234, 0.3);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 200px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.chat-tab:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: rgba(102, 126, 234, 0.5);
    transform: translateY(-2px);
}

.chat-tab.active {
    background: rgba(102, 126, 234, 0.15);
    border-color: rgba(102, 126, 234, 0.6);
}

.chat-tab-name {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 400;
}

.chat-tab-close {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    font-size: 1.2rem;
    line-height: 1;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
}

.chat-tab-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
}

/* Chat window (expanded) */
.chat-window {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid rgba(102, 126, 234, 0.3);
    border-radius: 8px;
    width: 350px;
    height: 450px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
}

.chat-window-header {
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-window-title {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
}

.chat-window-actions {
    display: flex;
    gap: 0.5rem;
}

.chat-window-action {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0.25rem;
    border-radius: 4px;
    transition: all 0.2s;
}

.chat-window-action:hover {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
}

.chat-window-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.chat-message-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 0.75rem;
    border-left: 2px solid rgba(102, 126, 234, 0.3);
}

.chat-message-item.own {
    background: rgba(102, 126, 234, 0.15);
    border-left-color: rgba(102, 126, 234, 0.5);
    align-self: flex-end;
    max-width: 80%;
}

.chat-message-sender {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 0.25rem;
    font-weight: 400;
}

.chat-message-content {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.9rem;
    line-height: 1.4;
    white-space: pre-wrap;
}

.chat-message-time {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.4);
    margin-top: 0.25rem;
}

.chat-window-input {
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding: 0.75rem;
    display: flex;
    gap: 0.5rem;
}

.chat-window-input textarea {
    flex: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    padding: 0.5rem;
    color: #fff;
    font-family: inherit;
    font-size: 0.9rem;
    resize: none;
    max-height: 60px;
}

.chat-window-input textarea:focus {
    outline: none;
    border-color: rgba(102, 126, 234, 0.5);
    background: rgba(255, 255, 255, 0.08);
}

.chat-window-send {
    background: rgba(102, 126, 234, 0.15);
    border: 1px solid rgba(102, 126, 234, 0.3);
    color: #8b9cff;
    border-radius: 6px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.chat-window-send:hover {
    background: rgba(102, 126, 234, 0.25);
    border-color: rgba(102, 126, 234, 0.5);
}

/* Conversations Modal Styles */
.conversations-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
}

.conversations-modal-content {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid rgba(102, 126, 234, 0.3);
    border-radius: 16px;
    width: 400px;
    max-height: 500px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    animation: slideUp 0.3s ease;
}

.conversations-modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.conversations-modal-header h3 {
    margin: 0;
    color: rgba(255, 255, 255, 0.9);
    font-size: 1.25rem;
    font-weight: 500;
}

.conversations-modal-close {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    font-size: 1.5rem;
    padding: 0.25rem;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.conversations-modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
}

.conversations-list {
    max-height: 350px;
    overflow-y: auto;
    padding: 1rem;
}

.conversation-item {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.conversation-content {
    flex: 1;
    cursor: pointer;
}

.conversation-item:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: rgba(102, 126, 234, 0.3);
    transform: translateY(-1px);
}

.conversation-delete {
    background: rgba(235, 51, 73, 0.1);
    border: 1px solid rgba(235, 51, 73, 0.3);
    color: #ff6b7a;
    border-radius: 6px;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 0.75rem;
    flex-shrink: 0;
}

.conversation-delete:hover {
    background: rgba(235, 51, 73, 0.2);
    border-color: rgba(235, 51, 73, 0.5);
    transform: scale(1.05);
}

.conversation-user {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.conversation-event {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.85rem;
}

.conversation-unread {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    background: #fa709a;
    color: white;
    font-size: 0.7rem;
    padding: 0.15rem 0.4rem;
    border-radius: 10px;
    font-weight: 500;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
(function() {
    const widget = document.getElementById('direct-chat-widget');
    
    if (!widget) {
        console.error('direct-chat-widget element not found');
        return;
    }
    
    let openChats = {}; // {chatId: {data...}}
    let activeChatId = null;
    let allChats = {}; // Store all user's chats with unread counts
    
    // Initialize chat widget for all pages
    initializeChatWidget();
    
    function initializeChatWidget() {
        // Load all user's chats on page load
        loadAllChats();
        
        // Restore chat state from localStorage
        restoreChatState();
        
        // Create container immediately
        createContainer();
    }
    
    // Handle "Message" button clicks
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-message')) {
            const btn = e.target.closest('.btn-message');
            const eventSlug = btn.dataset.event;
            const userId = btn.dataset.user;
            const username = btn.dataset.username;
            
            openOrCreateChat(eventSlug, userId, username);
        }
    });
    
    async function loadAllChats() {
        try {
            const response = await fetch('/events/chats/list/');
            const data = await response.json();
            
            data.chats.forEach(chat => {
                allChats[chat.chat_id] = chat;
            });
            
            updateNotification();
            updateUI(); // Force UI update after loading chats
            
            // Check for new messages every 3 seconds to reduce flickering
            setInterval(checkForNewMessages, 3000);
        } catch (error) {
            console.error('Error loading chats:', error);
        }
    }
    
    function updateNotification() {
        // Update UI to show current unread counts
        updateUI();
    }
    
    async function checkForNewMessages() {
        try {
            const response = await fetch('/events/chats/list/');
            const data = await response.json();
            
            data.chats.forEach(chat => {
                const previousUnread = allChats[chat.chat_id]?.unread_count || 0;
                const currentUnread = chat.unread_count;
                
                // If new message arrived
                if (currentUnread > previousUnread) {
                    // Check if this chat was previously left (not in allChats)
                    const wasLeft = !allChats[chat.chat_id];
                    
                    if (wasLeft) {
                        // Restore chat for user who left but received new message
                        console.log(`New message received in previously left chat with ${chat.other_user}. Restoring chat...`);
                    }
                    
                    // Update notification
                    updateNotification();
                }
                
                allChats[chat.chat_id] = chat;
            });
            
            updateNotification();
        } catch (error) {
            console.error('Error checking for new messages:', error);
        }
    }
    
    async function openExistingChat(chatId, username, userId, eventSlug) {
        openChats[chatId] = {
            chatId: chatId,
            otherId: userId,
            username: username,
            minimized: false
        };
        activeChatId = chatId;
        updateUI();
        loadMessages(chatId);
        startPolling(chatId);
    }
    
    async function openOrCreateChat(eventSlug, userId, username) {
        // Check if chat already exists
        const existingChat = Object.values(openChats).find(
            chat => chat.otherId === parseInt(userId)
        );
        
        if (existingChat) {
            // Switch to existing chat
            activeChatId = existingChat.chatId;
            updateUI();
            return;
        }
        
        // Create new chat
        try {
            const formData = new FormData();
            formData.append('other_user_id', userId);
            
            const response = await fetch(`/events/${eventSlug}/chat/create/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            });
            
            const data = await response.json();
            
            if (data.chat_id) {
                openChats[data.chat_id] = {
                    chatId: data.chat_id,
                    otherId: parseInt(userId),
                    username: username,
                    minimized: false
                };
                activeChatId = data.chat_id;
                updateUI();
                startPolling(data.chat_id);
            }
        } catch (error) {
            console.error('Error creating chat:', error);
        }
    }
    
    let lastUIState = null; // Track last UI state to prevent unnecessary updates
    
    function updateUI() {
        const container = document.querySelector('.direct-chat-container') || createContainer();
        
        // Calculate current state
        const totalUnread = Object.values(allChats).reduce((sum, chat) => sum + (chat.unread_count || 0), 0);
        const hasChats = Object.keys(allChats).length > 0;
        const openChatsCount = Object.keys(openChats).length;
        const currentState = {
            totalUnread,
            hasChats,
            openChatsCount,
            activeChatId,
            openChatsKeys: Object.keys(openChats).sort()
        };
        
        // Only update if state actually changed
        if (JSON.stringify(currentState) === JSON.stringify(lastUIState)) {
            return;
        }
        
        lastUIState = currentState;
        
        container.innerHTML = '';
        
        // Always show Chats button if there are any chats
        if (hasChats) {
            const conversationsButton = document.createElement('button');
            conversationsButton.className = 'conversations-button';
            conversationsButton.innerHTML = '💬 Chats';
            if (totalUnread > 0) {
                conversationsButton.innerHTML += `<span class="unread-badge">${totalUnread}</span>`;
            }
            conversationsButton.onclick = showConversationsList;
            container.appendChild(conversationsButton);
        }
        
        // Add minimized chat tabs
        Object.values(openChats).forEach(chat => {
            if (chat.minimized) {
                container.appendChild(createChatTab(chat));
            } else if (chat.chatId === activeChatId) {
                container.appendChild(createChatWindow(chat));
            }
        });
        
        // Save state to localStorage
        saveChatState();
    }
    
    function saveChatState() {
        const state = {
            openChats: openChats,
            activeChatId: activeChatId,
            hasChats: Object.keys(allChats).length > 0
        };
        localStorage.setItem('chatWidgetState', JSON.stringify(state));
    }
    
    function restoreChatState() {
        try {
            const savedState = localStorage.getItem('chatWidgetState');
            if (savedState) {
                const state = JSON.parse(savedState);
                if (state.hasChats) {
                    // Force UI update to show Chats button
                    setTimeout(() => {
                        updateUI();
                    }, 100);
                }
            }
        } catch (error) {
            console.error('Error restoring chat state:', error);
        }
    }
    
    function showConversationsList() {
        const chats = Object.values(allChats);
        if (chats.length === 0) {
            return;
        }
        
        // Create modal for conversations list
        const modal = document.createElement('div');
        modal.className = 'conversations-modal';
        modal.innerHTML = `
            <div class="conversations-modal-content">
                <div class="conversations-modal-header">
                    <h3>Chats</h3>
                    <button class="conversations-modal-close" onclick="closeConversationsModal()">×</button>
                </div>
                <div class="conversations-list">
                    ${chats.map(chat => `
                        <div class="conversation-item">
                            <div class="conversation-content" onclick="openChatFromList(${chat.chat_id}, '${chat.other_user}', ${chat.other_user_id}, '${chat.event_slug}')">
                                <div class="conversation-user">${chat.other_user}</div>
                                <div class="conversation-event">${chat.event_title}</div>
                                ${chat.unread_count > 0 ? `<span class="conversation-unread">${chat.unread_count}</span>` : ''}
                            </div>
                            <button class="conversation-delete" onclick="deleteChat(${chat.chat_id}, event)" title="Leave conversation">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close modal when clicking outside
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeConversationsModal();
            }
        });
    }
    
    function createContainer() {
        const container = document.createElement('div');
        container.className = 'direct-chat-container';
        document.body.appendChild(container);
        return container;
    }
    
    function createChatTab(chat) {
        const tab = document.createElement('div');
        tab.className = 'chat-tab';
        tab.dataset.chatId = chat.chatId;
        
        tab.innerHTML = `
            <span class="chat-tab-name">${chat.username}</span>
            <button class="chat-tab-close" onclick="closeChat(${chat.chatId})">×</button>
        `;
        
        tab.addEventListener('click', function() {
            activeChatId = chat.chatId;
            chat.minimized = false;
            updateUI();
        });
        
        return tab;
    }
    
    function createChatWindow(chat) {
        const window = document.createElement('div');
        window.className = 'chat-window';
        window.dataset.chatId = chat.chatId;
        
        window.innerHTML = `
            <div class="chat-window-header">
                <span class="chat-window-title">${chat.username}</span>
                <div class="chat-window-actions">
                    <button class="chat-window-action" onclick="minimizeChat(${chat.chatId})">−</button>
                    <button class="chat-window-action" onclick="closeChat(${chat.chatId})">×</button>
                </div>
            </div>
            <div class="chat-window-messages" id="chat-messages-${chat.chatId}"></div>
            <div class="chat-window-input">
                <textarea id="chat-input-${chat.chatId}" placeholder="Type a message..." rows="2"></textarea>
                <button class="chat-window-send" onclick="sendMessage(${chat.chatId})">Send</button>
            </div>
        `;
        
        // Auto-scroll
        const messagesDiv = window.querySelector(`#chat-messages-${chat.chatId}`);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Send on Enter - improved event handling
        const inputElement = window.querySelector(`#chat-input-${chat.chatId}`);
        if (inputElement) {
            // Remove any existing listeners to prevent duplicates
            inputElement.removeEventListener('keydown', inputElement._enterHandler);
            
            // Create new handler
            inputElement._enterHandler = function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    e.stopPropagation();
                    sendMessage(chat.chatId);
                }
            };
            
            inputElement.addEventListener('keydown', inputElement._enterHandler);
        }
        
        return window;
    }
    
    window.closeConversationsModal = function() {
        const modal = document.querySelector('.conversations-modal');
        if (modal) {
            modal.remove();
        }
    };
    
    window.openChatFromList = function(chatId, username, userId, eventSlug) {
        closeConversationsModal();
        openExistingChat(chatId, username, userId, eventSlug);
    };
    
    // Get CSRF token from cookies (more reliable)
    function getCSRFToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        // Fallback to form input
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }
    
    window.deleteChat = async function(chatId, event) {
        event.stopPropagation(); // Prevent opening chat when clicking delete
        
        if (!confirm('Are you sure you want to leave this conversation? You can rejoin later if needed.')) {
            return;
        }
        
        try {
            const response = await fetch(`/events/chat/${chatId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                // Remove from local state
                delete allChats[chatId];
                delete openChats[chatId];
                
                if (activeChatId === chatId) {
                    activeChatId = null;
                }
                
                // Update UI
                updateUI();
                closeConversationsModal();
                
                // Show success message
                console.log('Left conversation successfully');
            } else {
                console.error('Failed to leave conversation');
                alert('Failed to leave conversation. Please try again.');
            }
        } catch (error) {
            console.error('Error leaving conversation:', error);
            alert('Error leaving conversation. Please try again.');
        }
    };
    
    window.closeChat = function(chatId) {
        delete openChats[chatId];
        if (activeChatId === chatId) {
            activeChatId = null;
        }
        updateUI();
    };
    
    window.minimizeChat = function(chatId) {
        const chat = openChats[chatId];
        if (chat) {
            chat.minimized = true;
            activeChatId = null;
            updateUI();
        }
    };
    
    window.sendMessage = async function(chatId) {
        const input = document.getElementById(`chat-input-${chatId}`);
        const content = input.value.trim();
        
        if (!content) return;
        
        try {
            const formData = new FormData();
            formData.append('content', content);
            
            const response = await fetch(`/events/chat/${chatId}/send/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                input.value = '';
                loadMessages(chatId);
            }
        } catch (error) {
            console.error('Error sending message:', error);
        }
    };
    
    async function loadMessages(chatId) {
        try {
            const response = await fetch(`/events/chat/${chatId}/api/`);
            const data = await response.json();
            
            const messagesDiv = document.getElementById(`chat-messages-${chatId}`);
            if (!messagesDiv) return;
            
            // Always update messages - no complex logic
            messagesDiv.innerHTML = '';
            
            data.messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message-item ${msg.is_own ? 'own' : ''}`;
                
                if (!msg.is_own) {
                    messageDiv.innerHTML += `
                        <div class="chat-message-sender">${msg.sender}</div>
                    `;
                }
                
                messageDiv.innerHTML += `
                    <div class="chat-message-content">${escapeHtml(msg.content)}</div>
                    <div class="chat-message-time">${msg.created_at}</div>
                `;
                
                messagesDiv.appendChild(messageDiv);
            });
            
            // Always scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }
    
    function startPolling(chatId) {
        loadMessages(chatId);
        setInterval(() => {
            if (activeChatId === chatId && openChats[chatId] && !openChats[chatId].minimized) {
                loadMessages(chatId);
            }
        }, 2000); // Reduced frequency to prevent flickering
    }
    
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;',
            '\n': '<br>'
        };
        return text.replace(/[&<>"'\n]/g, function(m) {
            if (m === '\n') return '<br>';
            return map[m];
        });
    }
})();
</script>

